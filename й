// promocodes.js - –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤

// –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ
let legendaryClickCounter = 0;
let promoButton, promoModal, promoInput, promoActivate, promoClose, promoList, promoMessage;

const promoCodes = [
    // –û–±—ã—á–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã (–¥–∞—é—Ç –∫–ª—é—á–∏)
    {
        code: "CLICKER2024",
        reward: 5,
        type: "keys",
        used: false,
        description: "5 –∫–ª—é—á–µ–π"
    },
    {
        code: "WELCOME",
        reward: 3,
        type: "keys",
        used: false,
        description: "3 –∫–ª—é—á–∞"
    },
    {
        code: "ENERGY100",
        reward: 100,
        type: "energy",
        used: false,
        description: "+100 –∫ —Ç–µ–∫—É—â–µ–π —ç–Ω–µ—Ä–≥–∏–∏"
    },
    {
        code: "BOOSTER",
        reward: 50,
        type: "points",
        used: false,
        description: "50 –æ—á–∫–æ–≤"
    },
    {
        code: "SUPERCLICK",
        reward: 10,
        type: "clicks",
        used: false,
        description: "10 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª–∏–∫–æ–≤"
    },
    {
        code: "LUCKYDAY",
        reward: 2,
        type: "keys",
        used: false,
        description: "2 –∫–ª—é—á–∞"
    },
    {
        code: "PROMO2024",
        reward: 4,
        type: "keys",
        used: false,
        description: "4 –∫–ª—é—á–∞"
    },
    {
        code: "ENERGYMASTER",
        reward: 200,
        type: "energy",
        used: false,
        description: "+200 –∫ —Ç–µ–∫—É—â–µ–π —ç–Ω–µ—Ä–≥–∏–∏"
    },
    
    // –ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ –∫–µ–π—Å—ã
    {
        code: "FREECASE",
        reward: 1,
        type: "case_common",
        used: false,
        description: "1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –æ–±—ã—á–Ω—ã–π –∫–µ–π—Å"
    },
    {
        code: "LUCKYBOX",
        reward: 1,
        type: "case_rare",
        used: false,
        description: "1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ä–µ–¥–∫–∏–π –∫–µ–π—Å"
    },
    {
        code: "EPICGIFT",
        reward: 1,
        type: "case_epic",
        used: false,
        description: "1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —ç–ø–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å"
    },
    {
        code: "LEGENDARY2025",
        reward: 1,
        type: "case_legendary",
        used: false,
        description: "1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–µ–π—Å"
    },
    {
        code: "CASEMASTER",
        reward: 3,
        type: "case_common",
        used: false,
        description: "3 –æ–±—ã—á–Ω—ã—Ö –∫–µ–π—Å–∞"
    },
    {
        code: "BOXCOLLECTOR",
        reward: 2,
        type: "case_rare",
        used: false,
        description: "2 —Ä–µ–¥–∫–∏—Ö –∫–µ–π—Å–∞"
    },
    
    // –ü—Ä–æ–º–æ–∫–æ–¥—ã, –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
    {
        code: "WITHER666",
        reward: null,
        type: "special",
        specialUpgradeId: 201,
        used: false,
        description: "–ù–µ–∑–µ—Ä-–∫–ª—é—á"
    },
    {
        code: "ENDERDRAGON",
        reward: null,
        type: "special",
        specialUpgradeId: 202,
        used: false,
        description: "–≠–Ω–¥–µ—Ä-–∫–ª—é—á"
    },
    {
        code: "HERO2024",
        reward: null,
        type: "special",
        specialUpgradeId: 203,
        used: false,
        description: "–ö–ª—é—á –≥–µ—Ä–æ—è"
    },
    {
        code: "LEGENDARY",
        reward: null,
        type: "special",
        specialUpgradeId: 204,
        used: false,
        description: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–ª—é—á"
    },
    
    // –ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
    {
        code: "SKINLOVER",
        reward: 2,
        type: "skin_random",
        used: false,
        description: "–°–ª—É—á–∞–π–Ω—ã–π —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–π —Å–∫–∏–Ω"
    },
    {
        code: "UPGRADE10",
        reward: 10,
        type: "upgrade_points",
        used: false,
        description: "10 –æ—á–∫–æ–≤ —É–ª—É—á—à–µ–Ω–∏–π"
    },
    {
        code: "CRYSTALKEY",
        reward: 1,
        type: "exclusive_random",
        used: false,
        description: "–°–ª—É—á–∞–π–Ω–æ–µ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ"
    },
    // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–∏—Ç-–º–µ–Ω—é
    {
        code: "DEBUGMODE666",
        reward: null,
        type: "cheat_menu",
        used: false,
        description: "–ê–∫—Ç–∏–≤–∞—Ü–∏—è —á–∏—Ç-–º–µ–Ω—é (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞)"
    }
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–µ–π
function forceUpdateKeysDisplay() {
    console.log("–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π");
    
    const currentKeys = window.keys || 0;
    
    const keysElements = [
        document.getElementById('keysCount'),
        document.getElementById('skinsKeysCount'),
        document.getElementById('shopKeysCount'),
        document.getElementById('availableKeys'),
        document.getElementById('casesKeysCount')
    ];
    
    keysElements.forEach(el => {
        if (el) el.textContent = currentKeys;
    });
    
    if (typeof window.keys !== 'undefined') {
        window.keys = currentKeys;
    }
    
    if (typeof keys !== 'undefined') {
        keys = window.keys;
    }
    
    if (typeof updateKeysDisplay === 'function') {
        updateKeysDisplay();
    }
    
    if (typeof updateShopStats === 'function') {
        updateShopStats();
    }
    
    if (typeof updateLootBoxesKeys === 'function') {
        updateLootBoxesKeys();
    }
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function initPromoCodes() {
    console.log("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...");
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
    promoButton = document.getElementById('settingsPromo'); // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º settingsPromo, –Ω–µ promoButton
    promoModal = document.getElementById('promoModal');
    promoInput = document.getElementById('promoInput');
    promoActivate = document.getElementById('promoActivate');
    promoClose = document.getElementById('promoClose');
    promoList = document.getElementById('promoList');
    promoMessage = document.getElementById('promoMessage');
    
    console.log("–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:", {promoModal, promoInput, promoActivate, promoClose});
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
    if (promoButton) {
        console.log("–ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–∞–π–¥–µ–Ω–∞");
    } else {
        console.log("–ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º settingsPromo)");
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (promoClose) {
        promoClose.addEventListener('click', function() {
            hidePromoModal();
        });
    }
    
    if (promoActivate) {
        promoActivate.addEventListener('click', function() {
            activatePromoCode();
        });
    }
    
    if (promoModal) {
        promoModal.addEventListener('click', function(e) {
            if (e.target === promoModal) {
                hidePromoModal();
            }
        });
    }
    
    if (promoInput) {
        promoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                activatePromoCode();
            }
        });
    }
    
    updatePromoList();
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function showPromoModal() {
    console.log("showPromoModal –≤—ã–∑–≤–∞–Ω–∞");
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (!promoModal) {
        promoModal = document.getElementById('promoModal');
    }
    
    if (!promoModal) {
        console.error("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
        alert("–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
    promoModal.style.display = 'flex';
    console.log("–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –æ—Ç–∫—Ä—ã—Ç–æ");
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (!promoInput) {
        promoInput = document.getElementById('promoInput');
    }
    
    if (promoInput) {
        promoInput.value = '';
        promoInput.focus();
    }
    
    updatePromoList();
    
    if (typeof playClickSound === 'function') {
        playClickSound();
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function hidePromoModal() {
    if (!promoModal) {
        promoModal = document.getElementById('promoModal');
    }
    
    if (promoModal) {
        promoModal.style.display = 'none';
    }
    
    if (typeof playClickSound === 'function') {
        playClickSound();
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function updatePromoList() {
    if (!promoList) {
        promoList = document.getElementById('promoList');
    }
    
    if (!promoList) return;
    
    promoList.innerHTML = '<h3 style="color: #9b59b6; margin-bottom: 10px;">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:</h3>';
    
    const usedPromos = promoCodes.filter(promo => promo.used);
    
    if (usedPromos.length === 0) {
        promoList.innerHTML += '<p style="color: #aaa; text-align: center;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</p>';
        return;
    }
    
    usedPromos.forEach(promo => {
        const promoItem = document.createElement('div');
        promoItem.className = 'promo-item';
        
        promoItem.innerHTML = `
            <div>
                <span class="promo-code">${promo.code}</span>
                <div style="font-size: 0.8rem; color: #4CAF50;">‚úì –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</div>
            </div>
            <div class="promo-reward">
                <i class="fas fa-gift"></i> ${promo.description}
            </div>
        `;
        
        promoList.appendChild(promoItem);
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞ –∏–∑ –ø—Ä–æ–º–æ–∫–æ–¥–∞
function openCaseFromPromo(caseType, count = 1) {
    let caseId = 1;
    
    switch(caseType) {
        case 'case_rare':
            caseId = 2;
            break;
        case 'case_epic':
            caseId = 3;
            break;
        case 'case_legendary':
            caseId = 4;
            break;
        default:
            caseId = 1;
    }
    
    for (let i = 0; i < count; i++) {
        if (typeof openLootBox === 'function') {
            setTimeout(() => {
                openLootBox(caseId);
            }, i * 500);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
function activatePromoCode() {
    if (!promoInput) {
        promoInput = document.getElementById('promoInput');
    }
    
    if (!promoInput) return;
    
    const code = promoInput.value.trim().toUpperCase();
    console.log('–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞:', code);
    
    if (!code) {
        showPromoMessage("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥!", "error");
        return;
    }
    
    const promo = promoCodes.find(p => p.code === code);
    console.log('–ù–∞–π–¥–µ–Ω –ø—Ä–æ–º–æ–∫–æ–¥:', promo);
    
    if (!promo) {
        showPromoMessage("–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥!", "error");
        return;
    }
    
    if (promo.used) {
        showPromoMessage("–≠—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!", "error");
        return;
    }
    
    promo.used = true;
    console.log('–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, —Ç–∏–ø:', promo.type);
    
    if (promo.type === 'keys') {
        console.log('–ë—ã–ª–æ –∫–ª—é—á–µ–π:', window.keys);
        window.keys += promo.reward;
        if (typeof keys !== 'undefined') keys = window.keys;
        console.log('–°—Ç–∞–ª–æ –∫–ª—é—á–µ–π:', window.keys);
        showPromoMessage(`+${promo.reward} –∫–ª—é—á–µ–π!`, "success");
        forceUpdateKeysDisplay();
        
    } else if (promo.type === 'energy') {
        const effectiveMaxEnergy = (window.maxEnergy || 100) * (window.energyMultiplier || 1);
        window.currentEnergy = Math.min(effectiveMaxEnergy, (window.currentEnergy || 100) + promo.reward);
        showPromoMessage(`+${promo.reward} —ç–Ω–µ—Ä–≥–∏–∏!`, "success");
        if (typeof updateEnergyDisplay === 'function') updateEnergyDisplay();
        
    } else if (promo.type === 'points') {
        window.clickCount = (window.clickCount || 0) + promo.reward;
        window.totalPoints = (window.totalPoints || 0) + promo.reward;
        showPromoMessage(`+${promo.reward} –æ—á–∫–æ–≤!`, "success");
        if (typeof updateUI === 'function') updateUI();
        
    } else if (promo.type === 'clicks') {
        for (let i = 0; i < promo.reward; i++) {
            simulateClick();
        }
        showPromoMessage(`+${promo.reward} –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–ª–∏–∫–æ–≤!`, "success");
        
    } else if (promo.type.startsWith('case_')) {
        const caseNames = {
            'case_common': '–æ–±—ã—á–Ω—ã—Ö',
            'case_rare': '—Ä–µ–¥–∫–∏—Ö',
            'case_epic': '—ç–ø–∏—á–µ—Å–∫–∏—Ö',
            'case_legendary': '–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã—Ö'
        };
        const caseName = caseNames[promo.type] || '–∫–µ–π—Å–æ–≤';
        showPromoMessage(`+${promo.reward} ${caseName} –∫–µ–π—Å–æ–≤!`, "success");
        openCaseFromPromo(promo.type, promo.reward);
        
    } else if (promo.type === 'skin_random') {
        const exclusiveSkins = [2, 3, 4, 5, 6, 7, 8, 9, 10];
        const randomSkinId = exclusiveSkins[Math.floor(Math.random() * exclusiveSkins.length)];
        const skin = window.skins ? window.skins.find(s => s.id === randomSkinId) : null;
        
        if (skin) {
            skin.purchased = true;
            showPromoMessage(`–ü–æ–ª—É—á–µ–Ω —Å–∫–∏–Ω: ${skin.name}!`, "success");
            if (typeof renderSkins === 'function') renderSkins();
        }
        
    } else if (promo.type === 'upgrade_points') {
        window.clickCount = (window.clickCount || 0) + promo.reward * 100;
        window.totalPoints = (window.totalPoints || 0) + promo.reward * 100;
        showPromoMessage(`+${promo.reward * 100} –æ—á–∫–æ–≤ —É–ª—É—á—à–µ–Ω–∏–π!`, "success");
        if (typeof updateUI === 'function') updateUI();
        
    } else if (promo.type === 'exclusive_random') {
        const exclusives = [101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111];
        const randomExclusiveId = exclusives[Math.floor(Math.random() * exclusives.length)];
        const exclusive = window.allExclusiveUpgrades ? 
            window.allExclusiveUpgrades.find(u => u.id === randomExclusiveId) : null;
        
        if (exclusive && !exclusive.purchased) {
            exclusive.purchased = true;
            if (typeof applyExclusiveEffect === 'function') applyExclusiveEffect(exclusive);
            showPromoMessage(`–ü–æ–ª—É—á–µ–Ω–æ —É–ª—É—á—à–µ–Ω–∏–µ: ${exclusive.name}!`, "success");
            if (typeof initShop === 'function') initShop();
        } else {
            window.keys += 15;
            showPromoMessage(`–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: +15 –∫–ª—é—á–µ–π!`, "success");
            forceUpdateKeysDisplay();
        }
        
    } else if (promo.type === 'special') {
        if (typeof activateSpecialUpgrade === 'function') {
            const activatedUpgrade = activateSpecialUpgrade(promo.code);
            
            if (activatedUpgrade) {
                showPromoMessage(`–û—Ç–∫—Ä—ã—Ç–æ —É–ª—É—á—à–µ–Ω–∏–µ: ${activatedUpgrade.name}!`, "success");
                
                const shopTab = document.getElementById('shopTab');
                if (shopTab && shopTab.classList.contains('active') && typeof loadShopExclusive === 'function') {
                    loadShopExclusive();
                }
            } else {
                showPromoMessage("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —É–ª—É—á—à–µ–Ω–∏—è!", "error");
            }
        } else {
            showPromoMessage("–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–ª—É—á—à–µ–Ω–∏–π!", "error");
        }
        
    } else if (promo.type === 'cheat_menu') {
        if (typeof enableCheatMode === 'function') {
            enableCheatMode();
            showPromoMessage("üîß –ß–ò–¢-–ú–ï–ù–Æ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–û! üîß", "success");
            if (typeof toggleCheatMenu === 'function') {
                toggleCheatMenu();
            }
        } else {
            showPromoMessage("–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–∏—Ç-–º–µ–Ω—é!", "error");
        }
    }
    
    updatePromoList();
    
    if (typeof saveGame === 'function') saveGame();
    
    promoInput.value = '';
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
function showPromoMessage(text, type) {
    if (!promoMessage) {
        promoMessage = document.getElementById('promoMessage');
    }
    
    if (!promoMessage) return;
    
    promoMessage.textContent = text;
    promoMessage.className = `promo-message ${type}`;
    promoMessage.style.display = 'flex';
    
    setTimeout(() => {
        promoMessage.style.display = 'none';
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è —Å–∏–º—É–ª—è—Ü–∏–∏ –∫–ª–∏–∫–∞
function simulateClick() {
    if (window.currentEnergy < window.energyCost) return;
    
    window.currentEnergy -= window.energyCost;
    window.totalClicks++;
    window.clicksThisMinute++;
    
    const earnedPoints = window.clickValue * (window.energyCost / 5);
    window.clickCount += earnedPoints;
    window.totalPoints += earnedPoints;
    
    if (typeof updateUI === 'function') updateUI();
    if (typeof updateEnergyDisplay === 'function') updateEnergyDisplay();
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
function checkSpecialEffects() {
    const nezerKey = window.allExclusiveUpgrades ? 
        window.allExclusiveUpgrades.find(u => u.id === 201) : 
        null;
    if (nezerKey && nezerKey.purchased) {
        if (Math.random() < 0.05) {
            const bonus = window.clickValue * 9;
            window.clickCount += bonus;
            window.totalPoints += bonus;
            if (typeof showMessage === 'function') showMessage("–ù–ï–ó–ï–†-–ö–õ–Æ–ß! x10", "#9b59b6", 1000);
        }
    }
    
    const legendaryKey = window.allExclusiveUpgrades ? 
        window.allExclusiveUpgrades.find(u => u.id === 204) : 
        null;
    if (legendaryKey && legendaryKey.purchased) {
        legendaryClickCounter++;
        if (legendaryClickCounter >= 500) {
            legendaryClickCounter = 0;
            window.keys++;
            if (typeof keys !== 'undefined') keys = window.keys;
            forceUpdateKeysDisplay();
            if (typeof showMessage === 'function') showMessage("–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–ª—é—á: +1 –∫–ª—é—á!", "#ffd700", 1000);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≠–Ω–¥–µ—Ä-–∫–ª—é—á–∞
function enderGiftEffect() {
    const enderKey = window.allExclusiveUpgrades ? 
        window.allExclusiveUpgrades.find(u => u.id === 202) : 
        null;
    if (enderKey && enderKey.purchased) {
        window.clickCount += 1000;
        window.totalPoints += 1000;
        if (typeof showMessage === 'function') showMessage("–≠–Ω–¥–µ—Ä-–∫–ª—é—á: +1000 –æ—á–∫–æ–≤!", "#00adb5", 2000);
        if (typeof updateUI === 'function') updateUI();
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞ –≥–µ—Ä–æ—è
function getHeroBonus() {
    const heroKey = window.allExclusiveUpgrades ? 
        window.allExclusiveUpgrades.find(u => u.id === 203) : 
        null;
    return (heroKey && heroKey.purchased) ? heroKey.value : 0;
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function loadPromoCodes(savedData) {
    if (savedData && savedData.promoCodes) {
        savedData.promoCodes.forEach(savedPromo => {
            const promo = promoCodes.find(p => p.code === savedPromo.code);
            if (promo) {
                promo.used = savedPromo.used;
            }
        });
    }
    
    if (savedData && savedData.legendaryClickCounter) {
        legendaryClickCounter = savedData.legendaryClickCounter;
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function savePromoCodes() {
    return {
        promoCodes: promoCodes.map(p => ({ code: p.code, used: p.used })),
        legendaryClickCounter: legendaryClickCounter
    };
}

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
function resetPromoCodes() {
    promoCodes.forEach(promo => {
        promo.used = false;
    });
    legendaryClickCounter = 0;
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
window.checkSpecialEffects = checkSpecialEffects;
window.getHeroBonus = getHeroBonus;
window.enderGiftEffect = enderGiftEffect;
window.savePromoCodes = savePromoCodes;
window.loadPromoCodes = loadPromoCodes;
window.resetPromoCodes = resetPromoCodes;
window.initPromoCodes = initPromoCodes;
window.forceUpdateKeysDisplay = forceUpdateKeysDisplay;
window.showPromoModal = showPromoModal; // –í–∞–∂–Ω–æ!
window.hidePromoModal = hidePromoModal;
window.activatePromoCode = activatePromoCode;
